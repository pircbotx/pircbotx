<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>IdentServer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pircbotx</a> &gt; <a href="index.source.html" class="el_package">org.pircbotx</a> &gt; <span class="el_source">IdentServer.java</span></div><h1>IdentServer.java</h1><pre class="source lang-java linenums">// Generated by delombok at Mon Apr 13 22:36:03 CEST 2020
/**
 * Copyright (C) 2010-2014 Leon Blakey &lt;lord.quackstar at gmail.com&gt;
 *
 * This file is part of PircBotX.
 *
 * PircBotX is free software: you can redistribute it and/or modify it under the
 * terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later
 * version.
 *
 * PircBotX is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * PircBotX. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.pircbotx;

import com.google.common.base.Preconditions;
import java.io.BufferedReader;
import java.io.Closeable;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.net.InetAddress;
import java.net.InetSocketAddress;
import java.net.ServerSocket;
import java.net.Socket;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import org.apache.commons.lang3.StringUtils;

/**
 * A simple IdentServer (also know as &quot;The Identification Protocol&quot;). An ident
 * server provides a means to determine the identity of a user of a particular
 * TCP connection.
 * &lt;p&gt;
 * Most IRC servers attempt to contact the ident server on connecting hosts in
 * order to determine the user's identity. A few IRC servers will not allow you
 * to connect unless this information is provided.
 * &lt;p&gt;
 * So when a PircBotX is run on a machine that does not run an ident server, it
 * may be necessary to provide a &quot;faked&quot; response by starting up its own ident
 * server and sending out apparently correct responses.
 *
 * @since PircBot 0.9c
 * @author Leon Blakey
 */
public class IdentServer implements Closeable, Runnable {
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
<span class="fc" id="L56">	private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(IdentServer.class);</span>
	protected static final int DEFAULT_PORT = 113;
	protected static IdentServer server;
<span class="fc" id="L59">	protected static final Object INSTANCE_CREATE_LOCK = new Object();</span>
	protected final InetAddress localAddress;
	protected final Charset encoding;
	protected final ServerSocket serverSocket;
<span class="fc" id="L63">	protected final List&lt;IdentEntry&gt; identEntries = new ArrayList&lt;IdentEntry&gt;();</span>
	protected Thread runningThread;
	protected int port;
	
	/**
	 * Start the ident server with the systems default charset.
	 *
	 * @see Charset#defaultCharset()
	 */
	public static void startServer() {
<span class="nc" id="L73">		startServer(Charset.defaultCharset(), null);</span>
<span class="nc" id="L74">	}</span>
	
	/**
	 * Start the ident server with the specified charset.
	 *
	 * @param encoding The encoding to use for connections
	 */
	public static void startServer(Charset encoding, InetAddress localAddress) {
<span class="nc" id="L82">		synchronized (IdentServer.INSTANCE_CREATE_LOCK) {</span>
<span class="nc" id="L83">			startServer(encoding, localAddress, DEFAULT_PORT);</span>
<span class="nc" id="L84">		}</span>
<span class="nc" id="L85">	}</span>
	
	protected static void startServer(Charset encoding, InetAddress localAddress, int port) {
<span class="fc" id="L88">		synchronized (IdentServer.INSTANCE_CREATE_LOCK) {</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">			if (server != null) throw new RuntimeException(&quot;Already created an IdentServer instance&quot;);</span>
<span class="fc" id="L90">			server = new IdentServer(encoding, localAddress, port);</span>
<span class="fc" id="L91">			server.start();</span>
<span class="pc" id="L92">		}</span>
<span class="fc" id="L93">	}</span>
	
	/**
	 * Stop the server and clear pending ident responses.
	 *
	 * @throws IOException
	 */
	public static void stopServer() throws IOException {
<span class="fc" id="L101">		synchronized (IdentServer.INSTANCE_CREATE_LOCK) {</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">			if (server == null) throw new RuntimeException(&quot;Never created an IdentServer&quot;);</span>
<span class="fc" id="L103">			server.doClose();</span>
<span class="fc" id="L104">			server = null;</span>
<span class="pc" id="L105">		}</span>
<span class="fc" id="L106">	}</span>
	
	/**
	 * Create an ident server on port 113 with the specified encoding
	 *
	 * @param encoding Encoding to use for sockets
	 */
<span class="fc" id="L113">	protected IdentServer(Charset encoding, InetAddress localAddress, int port) {</span>
		try {
<span class="fc" id="L115">			this.encoding = encoding;</span>
<span class="fc" id="L116">			this.localAddress = localAddress;</span>
<span class="fc" id="L117">			this.serverSocket = new ServerSocket(port, 50, localAddress);</span>
<span class="fc" id="L118">			this.port = port;</span>
<span class="nc" id="L119">		} catch (Exception e) {</span>
<span class="nc" id="L120">			throw new RuntimeException(&quot;Could not create server socket for IdentServer on &quot; + localAddress.toString() + &quot;, port &quot; + port, e);</span>
<span class="fc" id="L121">		}</span>
<span class="fc" id="L122">	}</span>
	
	/**
	 * Start the ident server in a new thread.
	 */
	public void start() {
<span class="fc" id="L128">		runningThread = new Thread(this);</span>
<span class="fc" id="L129">		runningThread.setName(&quot;IdentServer&quot;);</span>
<span class="fc" id="L130">		runningThread.start();</span>
<span class="fc" id="L131">	}</span>
	
	/**
	 * Waits for a client to connect to the ident server before making an
	 * appropriate response.
	 */
	public void run() {
<span class="fc" id="L138">		log.info(&quot;IdentServer running on port &quot; + serverSocket.getLocalPort());</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">		while (!serverSocket.isClosed()) {</span>
<span class="fc" id="L140">			Socket socket = null;</span>
			try {
<span class="fc" id="L142">				socket = serverSocket.accept();</span>
<span class="fc" id="L143">				BufferedReader reader = new BufferedReader(new InputStreamReader(socket.getInputStream(), encoding));</span>
<span class="fc" id="L144">				OutputStreamWriter writer = new OutputStreamWriter(socket.getOutputStream(), encoding);</span>
<span class="fc" id="L145">				InetSocketAddress remoteAddress = (InetSocketAddress)socket.getRemoteSocketAddress();</span>
				//Read first line and process
<span class="fc" id="L147">				String line = reader.readLine();</span>
<span class="fc" id="L148">				String response = handleNextConnection(remoteAddress, line);</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">				if (response != null) {</span>
<span class="fc" id="L150">					writer.write(response);</span>
<span class="fc" id="L151">					writer.flush();</span>
				}
<span class="fc" id="L153">			} catch (Exception e) {</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">				if (serverSocket.isClosed()) {</span>
<span class="fc" id="L155">					log.debug(&quot;Server socket closed, exiting connection loop&quot;);</span>
<span class="fc" id="L156">					return;</span>
				} else 
				//This is not from the server socket closing
<span class="nc" id="L159">				throw new RuntimeException(&quot;Exception encountered when opening user socket&quot;, e);</span>
			} finally {
				//Close user socket
<span class="nc" id="L162">				try {</span>
<span class="pc bpc" id="L163" title="4 of 6 branches missed.">					if (socket != null) socket.close();</span>
<span class="nc" id="L164">				} catch (IOException e) {</span>
<span class="nc" id="L165">					throw new RuntimeException(&quot;Exception encountered when closing user socket&quot;, e);</span>
<span class="pc" id="L166">				}</span>
<span class="nc" id="L167">			}</span>
<span class="fc" id="L168">		}</span>
		//Done with connection loop, can safely close the socket now
<span class="nc bnc" id="L170" title="All 2 branches missed.">		if (!serverSocket.isClosed()) try {</span>
<span class="nc" id="L171">			close();</span>
<span class="nc" id="L172">		} catch (IOException e) {</span>
<span class="nc" id="L173">			log.error(&quot;Cannot close IdentServer socket&quot;, e);</span>
<span class="nc" id="L174">		}</span>
<span class="nc" id="L175">	}</span>
	
	/**
	 * Wait for and process the next connection.
	 *
	 * @throws IOException If any error occurred during reading or writing
	 */
	public String handleNextConnection(InetSocketAddress remoteAddress, String line) throws IOException {
		//Get and validate Ident from server
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">		if (StringUtils.isBlank(line)) {</span>
<span class="nc" id="L185">			log.error(&quot;Ignoring connection from &quot; + remoteAddress + &quot;, received blank line&quot;);</span>
<span class="nc" id="L186">			return null;</span>
		}
<span class="fc" id="L188">		String[] parsedLine = StringUtils.split(line, &quot;, &quot;);</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">		if (parsedLine.length != 2) {</span>
<span class="nc" id="L190">			log.error(&quot;Ignoring connection from &quot; + remoteAddress + &quot;, recieved unknown line: &quot; + line);</span>
<span class="nc" id="L191">			return null;</span>
		}
<span class="fc" id="L193">		int localPort = Utils.tryParseInt(parsedLine[0], -1);</span>
<span class="fc" id="L194">		int remotePort = Utils.tryParseInt(parsedLine[1], -1);</span>
<span class="pc bpc" id="L195" title="2 of 4 branches missed.">		if (localPort == -1 || remotePort == -1) {</span>
<span class="nc" id="L196">			log.error(&quot;Ignoring connection from &quot; + remoteAddress + &quot;, recieved unparsable line: &quot; + line);</span>
<span class="nc" id="L197">			return null;</span>
		}
		//Grab the IdentEntry for this ident
<span class="fc" id="L200">		log.debug(&quot;Received ident request from &quot; + remoteAddress + &quot;: &quot; + line);</span>
<span class="fc" id="L201">		IdentEntry identEntry = null;</span>
<span class="fc" id="L202">		synchronized (identEntries) {</span>
<span class="fc bfc" id="L203" title="All 8 branches covered.">			for (IdentEntry curIdentEntry : identEntries) if (curIdentEntry.getRemoteAddress().equals(remoteAddress.getAddress()) &amp;&amp; curIdentEntry.getRemotePort() == remotePort &amp;&amp; curIdentEntry.getLocalPort() == localPort) {</span>
<span class="fc" id="L204">				identEntry = curIdentEntry;</span>
<span class="fc" id="L205">				break;</span>
			}
<span class="pc" id="L207">		}</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">		if (identEntry == null) {</span>
<span class="fc" id="L209">			String response = localPort + &quot;, &quot; + remotePort + &quot; : ERROR : NO-USER&quot;;</span>
<span class="fc" id="L210">			log.error(&quot;Unknown ident &quot; + line + &quot; from &quot; + remoteAddress + &quot;, responding with: &quot; + response);</span>
<span class="fc" id="L211">			return response;</span>
		}
		//Respond to correct ident entry with login
<span class="fc" id="L214">		String response = line + &quot; : USERID : UNIX : &quot; + identEntry.getLogin();</span>
<span class="fc" id="L215">		log.debug(&quot;Responded to ident request from &quot; + remoteAddress + &quot; with: &quot; + response);</span>
<span class="fc" id="L216">		return response;</span>
	}
	
	protected void addIdentEntry(InetAddress remoteAddress, int remotePort, int localPort, String login) {
<span class="fc" id="L220">		synchronized (identEntries) {</span>
<span class="fc" id="L221">			log.debug(&quot;Added ident entry for address &quot; + remoteAddress + &quot; on port &quot; + remotePort + &quot; for local port &quot; + localPort + &quot; for &quot; + login);</span>
<span class="fc" id="L222">			identEntries.add(new IdentEntry(remoteAddress, remotePort, localPort, login));</span>
<span class="pc" id="L223">		}</span>
<span class="fc" id="L224">	}</span>
	
	protected void removeIdentEntry(InetAddress remoteAddress, int remotePort, int localPort, String login) {
<span class="nc" id="L227">		synchronized (identEntries) {</span>
<span class="nc" id="L228">			log.debug(&quot;Removed ident entry for address &quot; + remoteAddress + &quot; on port &quot; + remotePort + &quot; for local port &quot; + localPort + &quot; for &quot; + login);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">			for (Iterator&lt;IdentEntry&gt; itr = identEntries.iterator(); itr.hasNext(); ) {</span>
<span class="nc" id="L230">				IdentEntry curEntry = itr.next();</span>
<span class="nc bnc" id="L231" title="All 8 branches missed.">				if (curEntry.getRemoteAddress().equals(remoteAddress) &amp;&amp; curEntry.getRemotePort() == remotePort &amp;&amp; curEntry.getLocalPort() == localPort &amp;&amp; curEntry.getLogin().equals(login)) itr.remove();</span>
<span class="nc" id="L232">			}</span>
<span class="nc" id="L233">		}</span>
<span class="nc" id="L234">	}</span>
	
	protected int getPort() {
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">		Preconditions.checkState(!serverSocket.isClosed(), &quot;Server socket is not open&quot;);</span>
<span class="fc" id="L238">		return serverSocket.getLocalPort();</span>
	}
	
	/**
	 * Calls {@link #stopServer() }
	 * @throws IOException
	 */
	public void close() throws IOException {
<span class="nc" id="L246">		stopServer();</span>
<span class="nc" id="L247">	}</span>
	
	/**
	 * Close the server socket and clear pending ident responses.
	 *
	 * @throws IOException If an error occured during closing
	 */
	protected void doClose() throws IOException {
<span class="fc" id="L255">		serverSocket.close();</span>
<span class="fc" id="L256">		identEntries.clear();</span>
<span class="fc" id="L257">		log.info(&quot;Closed ident server on port &quot; + port + &quot;/&quot; + serverSocket.getLocalPort());</span>
<span class="fc" id="L258">	}</span>
	
	protected static class IdentEntry {
		protected final InetAddress remoteAddress;
		protected final int remotePort;
		protected final int localPort;
		protected final String login;
		
		@java.beans.ConstructorProperties({&quot;remoteAddress&quot;, &quot;remotePort&quot;, &quot;localPort&quot;, &quot;login&quot;})
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
<span class="fc" id="L269">		public IdentEntry(final InetAddress remoteAddress, final int remotePort, final int localPort, final String login) {</span>
<span class="fc" id="L270">			this.remoteAddress = remoteAddress;</span>
<span class="fc" id="L271">			this.remotePort = remotePort;</span>
<span class="fc" id="L272">			this.localPort = localPort;</span>
<span class="fc" id="L273">			this.login = login;</span>
<span class="fc" id="L274">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public InetAddress getRemoteAddress() {
<span class="fc" id="L279">			return this.remoteAddress;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int getRemotePort() {
<span class="fc" id="L285">			return this.remotePort;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int getLocalPort() {
<span class="fc" id="L291">			return this.localPort;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public String getLogin() {
<span class="fc" id="L297">			return this.login;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public boolean equals(final java.lang.Object o) {
<span class="nc bnc" id="L304" title="All 2 branches missed.">			if (o == this) return true;</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">			if (!(o instanceof IdentServer.IdentEntry)) return false;</span>
<span class="nc" id="L306">			final IdentEntry other = (IdentEntry)o;</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">			if (!other.canEqual((java.lang.Object)this)) return false;</span>
<span class="nc" id="L308">			final java.lang.Object this$remoteAddress = this.getRemoteAddress();</span>
<span class="nc" id="L309">			final java.lang.Object other$remoteAddress = other.getRemoteAddress();</span>
<span class="nc bnc" id="L310" title="All 6 branches missed.">			if (this$remoteAddress == null ? other$remoteAddress != null : !this$remoteAddress.equals(other$remoteAddress)) return false;</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">			if (this.getRemotePort() != other.getRemotePort()) return false;</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">			if (this.getLocalPort() != other.getLocalPort()) return false;</span>
<span class="nc" id="L313">			final java.lang.Object this$login = this.getLogin();</span>
<span class="nc" id="L314">			final java.lang.Object other$login = other.getLogin();</span>
<span class="nc bnc" id="L315" title="All 6 branches missed.">			if (this$login == null ? other$login != null : !this$login.equals(other$login)) return false;</span>
<span class="nc" id="L316">			return true;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		protected boolean canEqual(final java.lang.Object other) {
<span class="nc" id="L322">			return other instanceof IdentServer.IdentEntry;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int hashCode() {
<span class="nc" id="L329">			final int PRIME = 59;</span>
<span class="nc" id="L330">			int result = 1;</span>
<span class="nc" id="L331">			final java.lang.Object $remoteAddress = this.getRemoteAddress();</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">			result = result * PRIME + ($remoteAddress == null ? 43 : $remoteAddress.hashCode());</span>
<span class="nc" id="L333">			result = result * PRIME + this.getRemotePort();</span>
<span class="nc" id="L334">			result = result * PRIME + this.getLocalPort();</span>
<span class="nc" id="L335">			final java.lang.Object $login = this.getLogin();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">			result = result * PRIME + ($login == null ? 43 : $login.hashCode());</span>
<span class="nc" id="L337">			return result;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public java.lang.String toString() {
<span class="nc" id="L344">			return &quot;IdentServer.IdentEntry(remoteAddress=&quot; + this.getRemoteAddress() + &quot;, remotePort=&quot; + this.getRemotePort() + &quot;, localPort=&quot; + this.getLocalPort() + &quot;, login=&quot; + this.getLogin() + &quot;)&quot;;</span>
		}
	}
	
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
	protected static void setServer(final IdentServer server) {
<span class="nc" id="L351">		IdentServer.server = server;</span>
<span class="nc" id="L352">	}</span>
	
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
	protected static IdentServer getServer() {
<span class="fc" id="L357">		return IdentServer.server;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>